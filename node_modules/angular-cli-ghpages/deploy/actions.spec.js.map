{"version":3,"file":"actions.spec.js","sourceRoot":"","sources":["../../deploy/actions.spec.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  BuilderContext,\n  BuilderOutput,\n  BuilderRun,\n  ScheduleOptions,\n  Target\n} from '@angular-devkit/architect/src';\nimport { JsonObject, logging } from '@angular-devkit/core';\nimport { BuildTarget } from 'interfaces';\n\nimport deploy from './actions';\n\nlet context: BuilderContext;\nconst mockEngine = { run: (_: string, __: any, __2: any) => Promise.resolve() };\n\nconst PROJECT = 'pirojok-project';\nconst BUILD_TARGET: BuildTarget = {\n  name: `${PROJECT}:build:production`\n};\n\ndescribe('Deploy Angular apps', () => {\n  beforeEach(() => initMocks());\n\n  it('should invoke the builder', async () => {\n    const spy = spyOn(context, 'scheduleTarget').and.callThrough();\n    await deploy(mockEngine, context, BUILD_TARGET, {});\n\n    expect(spy).toHaveBeenCalledWith(\n      {\n        target: 'build',\n        configuration: 'production',\n        project: PROJECT\n      },\n      {}\n    );\n  });\n\n  it('should invoke the builder with the baseHref', async () => {\n    const spy = spyOn(context, 'scheduleTarget').and.callThrough();\n    await deploy(mockEngine, context, BUILD_TARGET, { baseHref: '/folder' });\n\n    expect(spy).toHaveBeenCalledWith(\n      {\n        target: 'build',\n        configuration: 'production',\n        project: PROJECT\n      },\n      { baseHref: '/folder' }\n    );\n  });\n\n  it('should invoke engine.run', async () => {\n    const spy = spyOn(mockEngine, 'run').and.callThrough();\n    await deploy(mockEngine, context, BUILD_TARGET, {});\n\n    expect(spy).toHaveBeenCalledWith('dist/some-folder', {}, context.logger);\n  });\n\n  describe('error handling', () => {\n    it('throws if there is no target project', async () => {\n      context.target = undefined;\n      try {\n        await deploy(mockEngine, context, BUILD_TARGET, {});\n        fail();\n      } catch (e) {\n        expect(e.message).toMatch(/Cannot execute the build target/);\n      }\n    });\n\n    it('throws if app building fails', async () => {\n      context.scheduleTarget = (\n        _: Target,\n        __?: JsonObject,\n        ___?: ScheduleOptions\n      ) =>\n        Promise.resolve({\n          result: Promise.resolve(createBuilderOutputMock(false))\n        } as BuilderRun);\n      try {\n        await deploy(mockEngine, context, BUILD_TARGET, {});\n        fail();\n      } catch (e) {\n        expect(e.message).toEqual('Error while building the app.');\n      }\n    });\n  });\n});\n\nconst initMocks = () => {\n  context = {\n    target: {\n      configuration: 'production',\n      project: PROJECT,\n      target: 'foo'\n    },\n    builder: {\n      builderName: 'mock',\n      description: 'mock',\n      optionSchema: false\n    },\n    currentDirectory: 'cwd',\n    id: 1,\n    logger: new logging.NullLogger() as any,\n    workspaceRoot: 'cwd',\n    addTeardown: _ => {},\n    validateOptions: _ => Promise.resolve({} as any),\n    getBuilderNameForTarget: () => Promise.resolve(''),\n    analytics: null as any,\n    getTargetOptions: (_: Target) =>\n      Promise.resolve({\n        outputPath: 'dist/some-folder'\n      }),\n    reportProgress: (_: number, __?: number, ___?: string) => {},\n    reportStatus: (_: string) => {},\n    reportRunning: () => {},\n    scheduleBuilder: (_: string, __?: JsonObject, ___?: ScheduleOptions) =>\n      Promise.resolve({} as BuilderRun),\n    scheduleTarget: (_: Target, __?: JsonObject, ___?: ScheduleOptions) =>\n      Promise.resolve({\n        result: Promise.resolve(createBuilderOutputMock(true))\n      } as BuilderRun)\n  } as any;\n};\n\nconst createBuilderOutputMock = (success: boolean): BuilderOutput => {\n  return {\n    info: { info: null },\n    // unfortunately error is undefined in case of a build errors\n    error: (undefined as unknown) as string,\n    success: success,\n    target: {} as Target\n  };\n};\n"]}